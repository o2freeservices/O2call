<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>o2 Connect â€¢ ØªÙ…Ø§Ø³ Ø§Ù…Ù†</title>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;600;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #0f172a; --panel: #1e293b; --primary: #3b82f6; --accent: #8b5cf6;
            --text: #f1f5f9; --muted: #94a3b8; --border: #334155; --radius: 20px;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; -webkit-tap-highlight-color: transparent; }
        body {
            font-family: 'Vazirmatn', sans-serif; background: var(--bg); color: var(--text);
            height: 100vh; display: flex; flex-direction: column; overflow: hidden;
        }

        /* Ù‡Ø´Ø¯Ø§Ø± Ø§Ù…Ù†ÛŒØªÛŒ */
        #securityAlert {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(15, 23, 42, 0.95); z-index: 9999;
            display: none; flex-direction: column; align-items: center; justify-content: center;
            padding: 30px; text-align: center;
        }
        .alert-box {
            background: #ef4444; color: white; padding: 20px; border-radius: 20px;
            max-width: 500px; box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        }

        .main-layout { display: grid; grid-template-columns: 1fr 400px; height: 100%; }
        .video-stage { position: relative; padding: 20px; display: flex; flex-direction: column; justify-content: center; align-items: center; background: #020617; }
        .video-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; width: 100%; max-width: 1200px; height: 70%; }
        .video-card { background: #000; border-radius: var(--radius); overflow: hidden; position: relative; box-shadow: 0 10px 30px rgba(0,0,0,0.5); border: 1px solid var(--border); }
        video { width: 100%; height: 100%; object-fit: cover; }
        #localVideo { transform: scaleX(-1); }
        .label { position: absolute; bottom: 15px; left: 15px; background: rgba(0,0,0,0.6); padding: 5px 12px; border-radius: 10px; font-size: 12px; backdrop-filter: blur(4px); }

        .controls-bar { margin-top: 20px; display: flex; gap: 15px; }
        .btn-circle { width: 60px; height: 60px; border-radius: 50%; border: none; cursor: pointer; background: var(--panel); color: white; font-size: 24px; display: flex; align-items: center; justify-content: center; transition: 0.2s; border: 1px solid var(--border); }
        .btn-circle:hover { transform: scale(1.1); background: var(--primary); }
        .btn-circle.danger { background: #ef4444; border-color: #ef4444; }

        .sidebar { background: var(--panel); border-right: 1px solid var(--border); padding: 25px; overflow-y: auto; display: flex; flex-direction: column; gap: 20px; box-shadow: -5px 0 20px rgba(0,0,0,0.3); }
        .header h1 { font-size: 24px; font-weight: 800; background: linear-gradient(to right, var(--primary), var(--accent)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .step-card { background: rgba(255,255,255,0.03); border: 1px solid var(--border); border-radius: 16px; padding: 20px; opacity: 0.5; pointer-events: none; filter: grayscale(0.5); transition: 0.3s; }
        .step-card.active { opacity: 1; pointer-events: all; filter: grayscale(0); border-color: var(--primary); box-shadow: 0 0 15px rgba(59, 130, 246, 0.1); }
        .step-title { font-size: 16px; font-weight: 700; margin-bottom: 12px; color: var(--primary); }
        
        .btn-block { width: 100%; padding: 14px; border-radius: 12px; border: none; cursor: pointer; background: var(--primary); color: white; font-family: inherit; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 8px; transition: 0.2s; margin-bottom: 10px; }
        .btn-block:hover { background: #2563eb; }
        .input-box { width: 100%; background: #0f172a; border: 1px solid var(--border); color: #fff; padding: 12px; border-radius: 12px; font-family: monospace; font-size: 12px; min-height: 80px; resize: none; margin-bottom: 10px; }
        
        @media (max-width: 900px) {
            .main-layout { grid-template-columns: 1fr; grid-template-rows: 1fr auto; }
            .sidebar { order: 2; height: auto; border-right: none; border-top: 1px solid var(--border); padding: 20px; }
            .video-stage { order: 1; height: 55vh; padding: 10px; }
            .video-grid { height: 100%; grid-template-columns: 1fr; }
            .video-card.local { position: absolute; width: 100px; height: 140px; bottom: 20px; right: 20px; z-index: 10; border: 2px solid rgba(255,255,255,0.2); }
            .controls-bar { position: absolute; top: 20px; left: 20px; margin:0; flex-direction: column; gap: 10px; }
            .btn-circle { width: 45px; height: 45px; font-size: 18px; background: rgba(0,0,0,0.5); backdrop-filter: blur(5px); }
        }
    </style>
</head>
<body>

<!-- Ù‡Ø´Ø¯Ø§Ø± Ø§Ù…Ù†ÛŒØªÛŒ -->
<div id="securityAlert">
    <div class="alert-box">
        <h2 style="margin-bottom:10px">âš ï¸ Ø®Ø·Ø§ÛŒ Ø§Ù…Ù†ÛŒØªÛŒ Ù…Ø±ÙˆØ±Ú¯Ø±</h2>
        <p style="margin-bottom:15px; font-size:14px; line-height:1.6">
            Ù…Ø±ÙˆØ±Ú¯Ø± Ø§Ø¬Ø§Ø²Ù‡ Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ø¯ÙˆØ±Ø¨ÛŒÙ† Ø±Ø§ Ø¯Ø± Ø§ÛŒÙ† Ø­Ø§Ù„Øª Ù†Ù…ÛŒâ€ŒØ¯Ù‡Ø¯.
            <br><br>
            <strong>Ø±Ø§Ù‡ Ø­Ù„:</strong><br>
            Û±. ÙØ§ÛŒÙ„ Ø±Ø§ Ø¨Ø§ <b>https</b> (Ù…Ø«Ù„ GitHub Pages ÛŒØ§ Netlify) Ø¨Ø§Ø² Ú©Ù†ÛŒØ¯.<br>
            Û². ÛŒØ§ Ø±ÙˆÛŒ <b>localhost</b> Ø§Ø¬Ø±Ø§ Ú©Ù†ÛŒØ¯.<br>
            Û³. ÙØ§ÛŒÙ„ Ø±Ø§ Ù…Ø³ØªÙ‚ÛŒÙ… (file://) ÛŒØ§ Ø¨Ø§ IP Ù…Ø¹Ù…ÙˆÙ„ÛŒ Ø¨Ø§Ø² Ù†Ú©Ù†ÛŒØ¯.
        </p>
        <button class="btn-block" style="background:white; color:#ef4444" onclick="location.reload()">ØªÙ„Ø§Ø´ Ù…Ø¬Ø¯Ø¯</button>
    </div>
</div>

<div class="main-layout">
    <div class="video-stage">
        <div class="video-grid">
            <div class="video-card local">
                <video id="localVideo" autoplay playsinline muted></video>
                <div class="label">Ø´Ù…Ø§</div>
            </div>
            <div class="video-card">
                <video id="remoteVideo" autoplay playsinline></video>
                <div class="label">Ù…Ø®Ø§Ø·Ø¨</div>
            </div>
        </div>
        <div class="controls-bar">
            <button class="btn-circle" id="micBtn">ğŸ¤</button>
            <button class="btn-circle danger" id="hangupBtn">âœ–</button>
            <button class="btn-circle" id="camBtn">ğŸ“·</button>
        </div>
    </div>

    <div class="sidebar">
        <div class="header">
            <h1>o2 Connect</h1>
            <p>ØªÙ…Ø§Ø³ Ø§Ù…Ù† P2P</p>
        </div>

        <!-- Ø¨Ø®Ø´ Ø´Ø±ÙˆØ¹ Ú©Ù†Ù†Ø¯Ù‡ -->
        <div id="hostSection">
            <div class="step-card active" id="step1">
                <div class="step-title">Û±. Ø³Ø§Ø®Øª Ù„ÛŒÙ†Ú© Ø¯Ø¹ÙˆØª</div>
                <button class="btn-block" id="createLinkBtn">ğŸ”— Ø³Ø§Ø®Øª Ù„ÛŒÙ†Ú©</button>
            </div>

            <div class="step-card" id="step2">
                <div class="step-title">Û². Ø§ØªØµØ§Ù„ Ù†Ù‡Ø§ÛŒÛŒ</div>
                <button class="btn-block" id="copyOfferBtn" style="background:#475569">ğŸ“‹ Ú©Ù¾ÛŒ Ù„ÛŒÙ†Ú© Ø¨Ø±Ø§ÛŒ Ø¯ÙˆØ³Øª</button>
                <hr style="border-color:var(--border); margin:15px 0">
                <p style="font-size:12px; color:var(--muted); margin-bottom:5px">Ú©Ø¯ ØªØ§ÛŒÛŒØ¯ÛŒ Ú©Ù‡ Ø¯ÙˆØ³ØªØªØ§Ù† Ø¯Ø§Ø¯ Ø±Ø§ Ø§ÛŒÙ†Ø¬Ø§ Ø¨Ø²Ù†ÛŒØ¯:</p>
                <textarea class="input-box" id="hostAnswerInput" placeholder="Ú©Ø¯ ØªØ§ÛŒÛŒØ¯ Ø±Ø§ Paste Ú©Ù†ÛŒØ¯..."></textarea>
                <button class="btn-block" id="connectHostBtn" style="background:#10b981">Ø§ØªØµØ§Ù„ âœ…</button>
            </div>
        </div>

        <!-- Ø¨Ø®Ø´ Ú¯ÛŒØ±Ù†Ø¯Ù‡ -->
        <div id="guestSection" style="display:none">
            <div class="step-card active" style="border-color:var(--accent)">
                <div class="step-title" style="color:var(--accent)">Ø¯Ø±ÛŒØ§ÙØª ØªÙ…Ø§Ø³</div>
                <p style="font-size:13px; color:var(--muted); margin-bottom:10px">Ù„ÛŒÙ†Ú© ØªØ§ÛŒÛŒØ¯ Ø´Ù…Ø§ Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø³Øª. Ø¢Ù† Ø±Ø§ Ú©Ù¾ÛŒ Ú©Ø±Ø¯Ù‡ Ùˆ Ø¨Ø±Ø§ÛŒ ÙØ±Ø³ØªÙ†Ø¯Ù‡ Ø¨ÙØ±Ø³ØªÛŒØ¯.</p>
                <textarea class="input-box" id="guestAnswerOutput" readonly onclick="this.select()"></textarea>
                <button class="btn-block" id="copyAnswerBtn" style="background:var(--accent)">ğŸ“‹ Ú©Ù¾ÛŒ ØªØ§ÛŒÛŒØ¯ÛŒÙ‡</button>
            </div>
        </div>
    </div>
</div>

<script>
    const config = { iceServers: [ { urls: "stun:stun.l.google.com:19302" } ] };
    let pc, localStream;

    // Ø¨Ø±Ø±Ø³ÛŒ Ø§Ù…Ù†ÛŒØª Ù¾Ø±ÙˆØªÚ©Ù„
    if (location.protocol !== 'https:' && location.hostname !== 'localhost' && location.hostname !== '127.0.0.1') {
        document.getElementById('securityAlert').style.display = 'flex';
    }

    function encodeData(data) { return encodeURIComponent(btoa(JSON.stringify(data))); }
    function decodeData(str) { return JSON.parse(atob(decodeURIComponent(str))); }

    const els = {
        localVid: document.getElementById('localVideo'),
        remoteVid: document.getElementById('remoteVideo'),
        createLinkBtn: document.getElementById('createLinkBtn'),
        step1: document.getElementById('step1'),
        step2: document.getElementById('step2'),
        copyOfferBtn: document.getElementById('copyOfferBtn'),
        hostAnswerInput: document.getElementById('hostAnswerInput'),
        connectHostBtn: document.getElementById('connectHostBtn'),
        hostSection: document.getElementById('hostSection'),
        guestSection: document.getElementById('guestSection'),
        guestAnswerOutput: document.getElementById('guestAnswerOutput'),
        copyAnswerBtn: document.getElementById('copyAnswerBtn')
    };

    async function startCamera() {
        try {
            localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
            els.localVid.srcObject = localStream;
            return true;
        } catch (err) {
            console.error(err);
            alert("Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ø¯ÙˆØ±Ø¨ÛŒÙ† Ø§Ù…Ú©Ø§Ù†â€ŒÙ¾Ø°ÛŒØ± Ù†ÛŒØ³Øª. \nÛ±. Ú†Ú© Ú©Ù†ÛŒØ¯ Ù¾Ø±ÙˆØªÚ©Ù„ HTTPS Ø¨Ø§Ø´Ø¯.\nÛ². Ø¯Ø³ØªØ±Ø³ÛŒ Ø±Ø§ Ø¯Ø± ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø³Ø§ÛŒØª Ù…Ø¬Ø§Ø² Ú©Ù†ÛŒØ¯.");
            return false;
        }
    }

    function createPC() {
        const p = new RTCPeerConnection(config);
        localStream.getTracks().forEach(t => p.addTrack(t, localStream));
        p.ontrack = e => els.remoteVid.srcObject = e.streams[0];
        return p;
    }

    // Host Logic
    els.createLinkBtn.onclick = async () => {
        if (!await startCamera()) return;
        els.createLinkBtn.textContent = "Ø¯Ø±Ø­Ø§Ù„ Ø³Ø§Ø®Øª...";
        els.createLinkBtn.disabled = true;

        pc = createPC();
        pc.createDataChannel("o2");
        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);

        pc.onicecandidate = e => {
            if (e.candidate === null) {
                window.inviteLink = location.origin + location.pathname + '?call=' + encodeData(pc.localDescription);
                els.step1.classList.remove('active');
                els.step2.classList.add('active');
            }
        };
    };

    els.copyOfferBtn.onclick = () => {
        navigator.clipboard.writeText(window.inviteLink);
        alert("Ù„ÛŒÙ†Ú© Ú©Ù¾ÛŒ Ø´Ø¯! Ø¨Ø±Ø§ÛŒ Ø¯ÙˆØ³ØªØª Ø¨ÙØ±Ø³Øª.");
    };

    els.connectHostBtn.onclick = async () => {
        try {
            const desc = decodeData(els.hostAnswerInput.value);
            await pc.setRemoteDescription(desc);
            els.connectHostBtn.textContent = "Ù…ØªØµÙ„ Ø´Ø¯ ğŸ‰";
        } catch(e) { alert("Ú©Ø¯ Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª"); }
    };

    // Guest Logic
    const params = new URLSearchParams(location.search);
    if (params.get('call')) {
        els.hostSection.style.display = 'none';
        els.guestSection.style.display = 'block';
        
        (async () => {
            if (!await startCamera()) return;
            pc = createPC();
            await pc.setRemoteDescription(decodeData(params.get('call')));
            const answer = await pc.createAnswer();
            await pc.setLocalDescription(answer);
            
            pc.onicecandidate = e => {
                if (e.candidate === null) {
                    els.guestAnswerOutput.value = encodeData(pc.localDescription);
                }
            };
        })();
    }

    els.copyAnswerBtn.onclick = () => {
        els.guestAnswerOutput.select();
        document.execCommand('copy');
        alert("Ú©Ø¯ Ú©Ù¾ÛŒ Ø´Ø¯! Ø¨Ø±Ø§ÛŒ ÙØ±Ø³ØªÙ†Ø¯Ù‡ Ø¨ÙØ±Ø³Øª.");
    };

    // Controls
    document.getElementById('micBtn').onclick = function() {
        localStream.getAudioTracks()[0].enabled = !localStream.getAudioTracks()[0].enabled;
        this.style.opacity = localStream.getAudioTracks()[0].enabled ? 1 : 0.5;
    };
    document.getElementById('camBtn').onclick = function() {
        localStream.getVideoTracks()[0].enabled = !localStream.getVideoTracks()[0].enabled;
        this.style.opacity = localStream.getVideoTracks()[0].enabled ? 1 : 0.5;
    };
    document.getElementById('hangupBtn').onclick = () => location.href = location.pathname;

</script>
</body>
</html>