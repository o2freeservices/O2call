<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>o2 Call | Ø§Ø±ØªØ¨Ø§Ø· Ù†Ù‡Ø§ÛŒÛŒ</title>
    <style>
        :root {
            --bg: #0f172a; --panel: #1e293b; --primary: #3b82f6; --success: #10b981; --err: #f43f5e;
            --text: #f1f5f9; --border: #334155;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; margin: 0; padding: 0; }
        body { font-family: system-ui, -apple-system, sans-serif; background: var(--bg); color: var(--text); height: 100vh; overflow: hidden; display: flex; flex-direction: column; }

        /* --- UI LAYOUT --- */
        .app-container { display: flex; height: 100%; width: 100%; position: relative; }
        
        /* Video Area */
        .stage { flex: 1; position: relative; background: #000; display: flex; align-items: center; justify-content: center; }
        video { width: 100%; height: 100%; object-fit: cover; }
        #localVideo {
            position: absolute; bottom: 20px; right: 20px; width: 110px; height: 150px;
            background: #111; border-radius: 12px; border: 2px solid rgba(255,255,255,0.2);
            object-fit: cover; transform: scaleX(-1); z-index: 20; box-shadow: 0 5px 15px rgba(0,0,0,0.5);
        }
        .overlay-status {
            position: absolute; top: 20px; left: 20px; background: rgba(0,0,0,0.7);
            padding: 8px 16px; border-radius: 30px; font-size: 13px; backdrop-filter: blur(8px);
            z-index: 10; display: flex; align-items: center; gap: 8px; border: 1px solid rgba(255,255,255,0.1);
        }
        .dot { width: 10px; height: 10px; border-radius: 50%; background: var(--err); box-shadow: 0 0 5px var(--err); transition: 0.3s; }
        .dot.active { background: var(--success); box-shadow: 0 0 10px var(--success); }

        /* Controls */
        .controls {
            position: absolute; bottom: 30px; display: flex; gap: 16px; z-index: 30;
            left: 50%; transform: translateX(-50%);
        }
        .icon-btn {
            width: 54px; height: 54px; border-radius: 50%; border: none; font-size: 22px;
            background: rgba(30, 41, 59, 0.85); color: white; cursor: pointer; backdrop-filter: blur(5px);
            display: flex; align-items: center; justify-content: center; transition: 0.2s; border: 1px solid rgba(255,255,255,0.1);
        }
        .icon-btn:active { transform: scale(0.9); }
        .icon-btn.hangup { background: var(--err); }
        .icon-btn.muted { opacity: 0.6; position: relative; }
        .icon-btn.muted::after { content: '/'; position: absolute; font-size: 30px; }

        /* Sidebar Panel */
        .sidebar {
            width: 360px; background: var(--panel); border-left: 1px solid var(--border);
            display: flex; flex-direction: column; z-index: 40; transition: transform 0.3s;
        }
        .panel-header { padding: 20px; border-bottom: 1px solid var(--border); font-weight: bold; font-size: 18px; }
        .panel-content { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 15px; }

        .card { background: rgba(255,255,255,0.03); border: 1px solid var(--border); padding: 16px; border-radius: 12px; }
        .step-badge {
            display: inline-block; background: var(--primary); color: white; padding: 2px 8px;
            border-radius: 4px; font-size: 11px; margin-bottom: 8px; font-weight: bold;
        }
        
        .btn {
            width: 100%; padding: 14px; background: var(--primary); color: white; border: none; border-radius: 10px;
            font-size: 14px; font-weight: bold; cursor: pointer; margin-top: 10px; transition: 0.2s;
        }
        .btn:disabled { background: #475569; cursor: wait; opacity: 0.7; }
        .btn.secondary { background: transparent; border: 1px solid var(--border); color: var(--text); }
        
        textarea {
            width: 100%; height: 80px; background: #0b1120; border: 1px solid var(--border); color: #cbd5e1;
            padding: 10px; border-radius: 8px; resize: none; font-family: monospace; font-size: 11px; margin-top: 5px;
        }
        textarea:focus { border-color: var(--primary); }

        .hidden { display: none !important; }
        
        /* Mobile Specific */
        @media (max-width: 800px) {
            .app-container { flex-direction: column; }
            .sidebar { width: 100%; height: auto; max-height: 50vh; border-left: none; border-top: 1px solid var(--border); position: absolute; bottom: 0; border-radius: 20px 20px 0 0; }
            #localVideo { width: 80px; height: 110px; bottom: 20px; right: 15px; top: auto; left: auto; }
            .controls { bottom: 20px; left: 20px; transform: none; flex-direction: column; gap: 10px; }
            .icon-btn { width: 45px; height: 45px; font-size: 18px; }
            .stage { height: 100%; }
        }
    </style>
</head>
<body>

<div class="app-container">
    <!-- VIDEO STAGE -->
    <div class="stage">
        <video id="remoteVideo" autoplay playsinline></video>
        <video id="localVideo" autoplay playsinline muted></video>
        
        <div class="overlay-status">
            <div class="dot" id="statusDot"></div>
            <span id="statusText">Ø§Ù†ØªØ¸Ø§Ø±...</span>
        </div>

        <div class="controls">
            <button class="icon-btn" id="micBtn" onclick="toggleMute()">ğŸ¤</button>
            <button class="icon-btn hangup" onclick="location.reload()">âœ–</button>
            <button class="icon-btn" id="camBtn" onclick="toggleCam()">ğŸ“·</button>
        </div>
    </div>

    <!-- CONTROL PANEL -->
    <div class="sidebar" id="sidebar">
        <div class="panel-header">Ø§Ø±ØªØ¨Ø§Ø· Ø§Ù…Ù† (o2)</div>
        
        <div class="panel-content">
            <!-- Loading -->
            <div id="loading" class="hidden" style="text-align: center; color: var(--primary);">
                <div style="margin-bottom: 10px;">â³</div>
                <div id="loadingText">Ø¯Ø± Ø­Ø§Ù„ Ù¾Ø±Ø¯Ø§Ø²Ø´...</div>
            </div>

            <!-- MODE 1: START CALL (HOST) -->
            <div id="host-start" class="card">
                <span class="step-badge">Ù…ÛŒØ²Ø¨Ø§Ù†</span>
                <h3>Ø´Ø±ÙˆØ¹ ØªÙ…Ø§Ø³ Ø¬Ø¯ÛŒØ¯</h3>
                <p style="font-size:12px; color:#94a3b8; margin:5px 0;">Ø¨Ø±Ø§ÛŒ Ø¨Ø±Ù‚Ø±Ø§Ø±ÛŒ ØªÙ…Ø§Ø³ØŒ Ø§Ø¨ØªØ¯Ø§ Ù„ÛŒÙ†Ú© Ø¯Ø¹ÙˆØª Ø±Ø§ Ø¨Ø³Ø§Ø²ÛŒØ¯.</p>
                <button class="btn" onclick="Host_CreateOffer()">Ø³Ø§Ø®Øª Ù„ÛŒÙ†Ú© Ø¯Ø¹ÙˆØª ğŸ”—</button>
            </div>

            <!-- MODE 2: SHARE LINK (HOST) -->
            <div id="host-share" class="card hidden">
                <span class="step-badge">Ù…Ø±Ø­Ù„Ù‡ Û²</span>
                <h3>Ø§Ø±Ø³Ø§Ù„ Ù„ÛŒÙ†Ú©</h3>
                <p style="font-size:12px; color:#94a3b8;">Ø§ÛŒÙ† Ù„ÛŒÙ†Ú© Ø±Ø§ Ø¨Ø±Ø§ÛŒ Ù…Ø®Ø§Ø·Ø¨ Ø¨ÙØ±Ø³ØªÛŒØ¯:</p>
                <button class="btn secondary" id="btnCopyLink" onclick="UI_CopyLink()">ğŸ“‹ Ú©Ù¾ÛŒ Ù„ÛŒÙ†Ú©</button>
                
                <div style="margin:15px 0; border-bottom:1px dashed var(--border)"></div>
                
                <span class="step-badge">Ù…Ø±Ø­Ù„Ù‡ Û³</span>
                <h3>ØªØ§ÛŒÛŒØ¯ Ø§ØªØµØ§Ù„</h3>
                <p style="font-size:12px; color:#94a3b8;">Ú©Ø¯ÛŒ Ú©Ù‡ Ù…Ø®Ø§Ø·Ø¨ Ø¨Ù‡ Ø´Ù…Ø§ Ø¯Ø§Ø¯ Ø±Ø§ Ø§ÛŒÙ†Ø¬Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:</p>
                <textarea id="hostInputAnswer" placeholder="Ú©Ø¯ ØªØ§ÛŒÛŒØ¯ Ø±Ø§ Ø§ÛŒÙ†Ø¬Ø§ Paste Ú©Ù†ÛŒØ¯..."></textarea>
                <button class="btn" onclick="Host_FinalizeConnect()" style="background:var(--success)">Ø§ØªØµØ§Ù„ Ù†Ù‡Ø§ÛŒÛŒ âš¡</button>
            </div>

            <!-- MODE 3: JOIN CALL (GUEST) -->
            <div id="guest-join" class="card hidden">
                <span class="step-badge">Ù…Ù‡Ù…Ø§Ù†</span>
                <h3>Ø¯Ø±ÛŒØ§ÙØª ØªÙ…Ø§Ø³</h3>
                <p style="font-size:12px; color:#94a3b8;">Ø¯Ø± Ø­Ø§Ù„ Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø¯Ø±Ø®ÙˆØ§Ø³Øª ØªÙ…Ø§Ø³...</p>
                <button class="btn" id="guestStartBtn" onclick="Guest_ProcessLink()">ğŸ“ Ù¾Ø§Ø³Ø® Ø¨Ù‡ ØªÙ…Ø§Ø³</button>
            </div>

            <!-- MODE 4: GUEST ANSWER -->
            <div id="guest-result" class="card hidden">
                <span class="step-badge" style="background:var(--success)">Ù¾Ø§Ø³Ø® Ø¢Ù…Ø§Ø¯Ù‡ Ø´Ø¯</span>
                <p style="font-size:12px; color:#94a3b8; margin-top:5px;">Ø§ÛŒÙ† Ú©Ø¯ Ø±Ø§ Ú©Ù¾ÛŒ Ú©Ù†ÛŒØ¯ Ùˆ Ø¨Ø±Ø§ÛŒ Ù…ÛŒØ²Ø¨Ø§Ù† Ø¨ÙØ±Ø³ØªÛŒØ¯:</p>
                <textarea id="guestOutput" readonly onclick="this.select()"></textarea>
                <button class="btn" onclick="UI_CopyGuestCode()">ğŸ“‹ Ú©Ù¾ÛŒ Ú©Ø¯ ØªØ§ÛŒÛŒØ¯</button>
            </div>
            
            <!-- DEBUG / ERROR BOX -->
            <div id="errorBox" class="card hidden" style="border-color:var(--err); background:rgba(239, 68, 68, 0.1);">
                <div style="color:var(--err); font-size:12px; font-weight:bold" id="errorText"></div>
            </div>
        </div>
    </div>
</div>

<script>
    // --- CORE CONFIGURATION ---
    const CONFIG = {
        iceServers: [
            { urls: "stun:stun.l.google.com:19302" },
            { urls: "stun:stun1.l.google.com:19302" },
            { urls: "stun:stun2.l.google.com:19302" }
        ],
        iceCandidatePoolSize: 10
    };

    // --- GLOBAL VARIABLES ---
    let pc = null;
    let localStream = null;
    let pendingOffer = null; // To store offer from URL

    // --- UTILS: COMPRESSION & ENCODING ---
    // We use a simplified custom encoding to reduce URL size safely
    const Codec = {
        encode: (data) => {
            try {
                // Remove spaces and unnecessary chars to shrink size
                const json = JSON.stringify(data);
                return encodeURIComponent(btoa(json));
            } catch(e) { console.error(e); return ""; }
        },
        decode: (str) => {
            try {
                // Heal broken strings (common in copy-paste)
                let clean = str.replace(/\s/g, ''); 
                clean = decodeURIComponent(clean);
                return JSON.parse(atob(clean));
            } catch(e) {
                console.error("Decoding Failed:", e);
                return null;
            }
        }
    };

    // --- UI MANAGER ---
    const UI = {
        show: (id) => document.getElementById(id).classList.remove('hidden'),
        hide: (id) => document.getElementById(id).classList.add('hidden'),
        hideAll: () => {
            ['host-start', 'host-share', 'guest-join', 'guest-result', 'loading'].forEach(id => document.getElementById(id).classList.add('hidden'));
        },
        log: (msg) => {
            const eb = document.getElementById('errorText');
            document.getElementById('errorBox').classList.remove('hidden');
            eb.textContent = msg;
            setTimeout(() => document.getElementById('errorBox').classList.add('hidden'), 5000);
        },
        setStatus: (text, active) => {
            document.getElementById('statusText').textContent = text;
            if(active) document.getElementById('statusDot').classList.add('active');
            else document.getElementById('statusDot').classList.remove('active');
        },
        loading: (show, text="...") => {
            if(show) { UI.hideAll(); UI.show('loading'); document.getElementById('loadingText').textContent = text; }
            else { UI.hide('loading'); }
        }
    };

    // --- 1. MEDIA HANDLING ---
    async function startCamera() {
        if (localStream) return true; // Already started
        try {
            localStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" }, audio: true });
            document.getElementById('localVideo').srcObject = localStream;
            return true;
        } catch (err) {
            UI.log("âŒ Ø®Ø·Ø§: Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ø¯ÙˆØ±Ø¨ÛŒÙ†/Ù…ÛŒÚ©Ø±ÙˆÙÙˆÙ† Ø¯Ø§Ø¯Ù‡ Ù†Ø´Ø¯.");
            return false;
        }
    }

    // --- 2. WEBRTC ENGINE ---
    function createPeerConnection() {
        if(pc) pc.close();
        pc = new RTCPeerConnection(CONFIG);

        // Add Tracks
        if(localStream) {
            localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
        }

        // Handle Incoming Stream
        pc.ontrack = (event) => {
            console.log("Stream received!");
            document.getElementById('remoteVideo').srcObject = event.streams[0];
            UI.setStatus("Ù…ØªØµÙ„ Ø´Ø¯", true);
            // Hide Sidebar on Mobile when connected
            if(window.innerWidth < 800) document.getElementById('sidebar').style.display = 'none';
        };

        // Handle Connection State
        pc.onconnectionstatechange = () => {
            const state = pc.connectionState;
            document.getElementById('statusText').textContent = state;
            if (state === 'connected') UI.setStatus("Ù…ØªØµÙ„ Ø´Ø¯", true);
            if (state === 'disconnected' || state === 'failed') UI.setStatus("Ù‚Ø·Ø¹ Ø´Ø¯", false);
        };

        return pc;
    }

    // â˜…â˜…â˜… THE SECRET SAUCE: FORCE WAIT FOR ICE â˜…â˜…â˜…
    function waitForICE(peerConn) {
        return new Promise(resolve => {
            if (peerConn.iceGatheringState === 'complete') {
                resolve();
            } else {
                let checkInterval;
                // Timeout after 3 seconds to prevent hanging
                const timeout = setTimeout(() => {
                    clearInterval(checkInterval);
                    console.warn("ICE Gathering Timeout - Proceeding anyway");
                    resolve();
                }, 3000);

                peerConn.onicecandidate = (e) => {
                    if (e.candidate === null) {
                        clearTimeout(timeout);
                        resolve();
                    }
                };
            }
        });
    }

    // --- 3. HOST LOGIC ---
    async function Host_CreateOffer() {
        if (!await startCamera()) return;

        UI.loading(true, "Ø¯Ø± Ø­Ø§Ù„ Ø´Ù†Ø§Ø³Ø§ÛŒÛŒ Ø´Ø¨Ú©Ù‡ (Ø§ÛŒÙ† Ù…Ø±Ø­Ù„Ù‡ Ø­ÛŒØ§ØªÛŒ Ø§Ø³Øª)...");
        
        pc = createPeerConnection();
        pc.createDataChannel("chat"); // Dummy channel to wake up ICE

        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);

        // WAIT for candidates
        await waitForICE(pc);

        // Generate Code
        const code = Codec.encode(pc.localDescription);
        const link = window.location.origin + window.location.pathname + '?d=' + code;
        window.generatedLink = link;

        // Verify length warning
        if(link.length > 2000) console.warn("Link is very long, might be truncated by some browsers.");

        UI.loading(false);
        UI.show('host-share');
    }

    async function Host_FinalizeConnect() {
        const rawCode = document.getElementById('hostInputAnswer').value.trim();
        if(!rawCode) return UI.log("Ú©Ø¯ ØªØ§ÛŒÛŒØ¯ ÙˆØ§Ø±Ø¯ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª!");

        const answerDesc = Codec.decode(rawCode);
        if(!answerDesc) return UI.log("ÙØ±Ù…Øª Ú©Ø¯ Ø§Ø´ØªØ¨Ø§Ù‡ Ø§Ø³Øª.");

        try {
            await pc.setRemoteDescription(answerDesc);
            UI.log("Ø§ØªØµØ§Ù„ Ø¨Ø±Ù‚Ø±Ø§Ø± Ø´Ø¯! ğŸ‰");
        } catch (e) {
            console.error(e);
            UI.log("Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„ Ù†Ù‡Ø§ÛŒÛŒ.");
        }
    }

    function UI_CopyLink() {
        navigator.clipboard.writeText(window.generatedLink).then(() => {
            const btn = document.getElementById('btnCopyLink');
            const original = btn.textContent;
            btn.textContent = "Ú©Ù¾ÛŒ Ø´Ø¯ âœ…";
            setTimeout(() => btn.textContent = original, 2000);
        });
    }

    // --- 4. GUEST LOGIC ---
    // Initialize Guest Mode if URL has data
    window.onload = () => {
        const params = new URLSearchParams(window.location.search);
        const data = params.get('d');
        if (data) {
            pendingOffer = data;
            UI.hideAll();
            UI.show('guest-join'); // Show "Answer Call" button
        }
    };

    async function Guest_ProcessLink() {
        if (!await startCamera()) return;
        
        UI.loading(true, "Ø¯Ø± Ø­Ø§Ù„ Ù¾Ø±Ø¯Ø§Ø²Ø´ Ù„ÛŒÙ†Ú©...");

        const offerDesc = Codec.decode(pendingOffer);
        if(!offerDesc) {
            UI.loading(false);
            UI.log("Ù„ÛŒÙ†Ú© Ø®Ø±Ø§Ø¨ ÛŒØ§ Ù†Ø§Ù‚Øµ Ø§Ø³Øª.");
            return;
        }

        try {
            pc = createPeerConnection();
            await pc.setRemoteDescription(offerDesc);

            const answer = await pc.createAnswer();
            await pc.setLocalDescription(answer);

            // WAIT for guest ICE
            await waitForICE(pc);

            const answerCode = Codec.encode(pc.localDescription);
            document.getElementById('guestOutput').value = answerCode;

            UI.loading(false);
            UI.show('guest-result');

        } catch (e) {
            console.error(e);
            UI.loading(false);
            UI.log("Ø®Ø·Ø§ Ø¯Ø± Ù¾Ø±Ø¯Ø§Ø²Ø´. Ù„ÛŒÙ†Ú© Ù…Ù…Ú©Ù† Ø§Ø³Øª Ù…Ù†Ù‚Ø¶ÛŒ Ø´Ø¯Ù‡ Ø¨Ø§Ø´Ø¯.");
        }
    }

    function UI_CopyGuestCode() {
        const txt = document.getElementById('guestOutput');
        txt.select();
        txt.setSelectionRange(0, 99999); // Mobile
        navigator.clipboard.writeText(txt.value);
        UI.log("Ú©Ù¾ÛŒ Ø´Ø¯! Ø¨Ø±Ø§ÛŒ Ù…ÛŒØ²Ø¨Ø§Ù† Ø¨ÙØ±Ø³ØªÛŒØ¯.");
    }

    // --- 5. MEDIA CONTROLS ---
    function toggleMute() {
        if(localStream) {
            const t = localStream.getAudioTracks()[0];
            t.enabled = !t.enabled;
            document.getElementById('micBtn').classList.toggle('muted', !t.enabled);
        }
    }
    function toggleCam() {
        if(localStream) {
            const t = localStream.getVideoTracks()[0];
            t.enabled = !t.enabled;
            document.getElementById('camBtn').classList.toggle('muted', !t.enabled);
        }
    }

</script>
</body>
</html>
