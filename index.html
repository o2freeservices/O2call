<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>o2 Call | ØªÙ…Ø§Ø³ Ø¨Ø¯ÙˆÙ† Ù‚Ø·Ø¹ÛŒ</title>
    <style>
        :root { --bg: #111827; --surface: #1f2937; --primary: #3b82f6; --text: #f3f4f6; --err: #ef4444; --ok: #10b981; }
        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; -webkit-tap-highlight-color: transparent; }
        body { background: var(--bg); color: var(--text); font-family: system-ui, sans-serif; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        /* --- STAGE (VIDEO) --- */
        .stage { flex: 1; position: relative; background: #000; display: flex; align-items: center; justify-content: center; }
        video { width: 100%; height: 100%; object-fit: cover; }
        #localVideo {
            position: absolute; width: 100px; height: 140px; bottom: 90px; right: 20px;
            border-radius: 12px; border: 2px solid rgba(255,255,255,0.3); background: #222;
            z-index: 10; transform: scaleX(-1); object-fit: cover; box-shadow: 0 4px 10px #000;
        }
        
        /* --- CONTROLS --- */
        .controls {
            position: absolute; bottom: 20px; left: 0; right: 0; display: flex; justify-content: center; gap: 20px; z-index: 20;
        }
        .btn-circle {
            width: 55px; height: 55px; border-radius: 50%; border: none; font-size: 24px;
            background: rgba(255,255,255,0.15); backdrop-filter: blur(5px); color: #fff; cursor: pointer;
            display: flex; align-items: center; justify-content: center; transition: 0.2s;
        }
        .btn-circle.red { background: var(--err); }
        .btn-circle:active { transform: scale(0.9); }

        /* --- MODAL / PANEL --- */
        .panel {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg);
            z-index: 50; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px;
            transition: transform 0.3s ease;
        }
        .panel.minimized { transform: translateY(100%); } /* Hide panel when connected */
        
        .card { background: var(--surface); padding: 16px; border-radius: 16px; border: 1px solid #374151; }
        h2 { font-size: 16px; margin-bottom: 10px; color: var(--primary); }
        p { font-size: 13px; color: #9ca3af; margin-bottom: 12px; line-height: 1.5; }
        
        .btn {
            width: 100%; padding: 14px; background: var(--primary); color: white; border: none;
            border-radius: 10px; font-weight: bold; font-size: 14px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .btn.sec { background: transparent; border: 2px solid #374151; color: #e5e7eb; }
        .btn:disabled { opacity: 0.5; cursor: wait; }
        
        textarea {
            width: 100%; background: #111827; border: 1px solid #374151; color: #d1d5db;
            padding: 12px; border-radius: 8px; font-family: monospace; font-size: 11px; resize: none; height: 80px;
        }
        textarea:focus { border-color: var(--primary); }

        .hidden { display: none !important; }
        .badge { display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 10px; background: #374151; margin-bottom: 5px; }
        
        /* Copy Feedback */
        .toast {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            background: var(--ok); color: white; padding: 8px 16px; border-radius: 20px; font-size: 12px;
            z-index: 100; display: none; box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
    </style>
</head>
<body>

<div class="toast" id="toast">Ú©Ù¾ÛŒ Ø´Ø¯! âœ…</div>

<!-- VIDEO AREA -->
<div class="stage">
    <video id="remoteVideo" autoplay playsinline></video>
    <video id="localVideo" autoplay playsinline muted></video>
    <div class="controls">
        <button class="btn-circle" onclick="toggleMute(this)">ğŸ¤</button>
        <button class="btn-circle red" onclick="location.href=location.pathname">âœ–</button>
        <button class="btn-circle" onclick="toggleCam(this)">ğŸ“·</button>
    </div>
</div>

<!-- SETUP PANEL -->
<div class="panel" id="mainPanel">
    <h1 style="font-size: 20px;">o2 Call <span style="font-size:12px; color:#6b7280; font-weight:400">ØªÙ…Ø§Ø³ Ø§Ù…Ù† P2P</span></h1>

    <!-- SECTION: START -->
    <div id="step-start">
        <div class="card">
            <h2>Ø´Ø±ÙˆØ¹ ØªÙ…Ø§Ø³</h2>
            <p>Ø¨Ø±Ø§ÛŒ Ø¨Ø±Ù‚Ø±Ø§Ø±ÛŒ ØªÙ…Ø§Ø³ Ø¬Ø¯ÛŒØ¯ØŒ Ø±ÙˆÛŒ Ø¯Ú©Ù…Ù‡ Ø²ÛŒØ± Ø¨Ø²Ù†ÛŒØ¯.</p>
            <button class="btn" onclick="HOST_Start()" id="btnStart">ğŸš€ Ø§ÛŒØ¬Ø§Ø¯ Ù„ÛŒÙ†Ú© Ø¯Ø¹ÙˆØª</button>
        </div>
        
        <div style="text-align:center; margin: 15px 0; color:#4b5563; font-size:12px;">--- ÛŒØ§ ---</div>

        <div class="card" style="border-color: #374151;">
            <h2>Ø¯Ø±ÛŒØ§ÙØª ØªÙ…Ø§Ø³ (Ø¯Ø³ØªÛŒ)</h2>
            <p>Ø§Ú¯Ø± Ù„ÛŒÙ†Ú© Ú©Ø§Ø± Ù†Ú©Ø±Ø¯ØŒ Ú©Ø¯ Ø·ÙˆÙ„Ø§Ù†ÛŒ Ú©Ù‡ Ø¯ÙˆØ³ØªØªØ§Ù† ÙØ±Ø³ØªØ§Ø¯Ù‡ Ø±Ø§ Ø§ÛŒÙ†Ø¬Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:</p>
            <button class="btn sec" onclick="GUEST_ShowManual()">âœï¸ ÙˆØ§Ø±Ø¯ Ú©Ø±Ø¯Ù† Ú©Ø¯ Ø¯Ø³ØªÛŒ</button>
        </div>
    </div>

    <!-- SECTION: HOST SHARE -->
    <div id="step-host-share" class="hidden">
        <div class="card">
            <span class="badge">Ù…Ø±Ø­Ù„Ù‡ Û± Ø§Ø² Û²</span>
            <h2>Ø§Ø±Ø³Ø§Ù„ Ø¯Ø¹ÙˆØªÙ†Ø§Ù…Ù‡</h2>
            <p>Ù„ÛŒÙ†Ú© Ø²ÛŒØ± Ø±Ø§ Ø¨Ø±Ø§ÛŒ Ø¯ÙˆØ³ØªØªØ§Ù† Ø¨ÙØ±Ø³ØªÛŒØ¯. Ø§Ú¯Ø± Ù„ÛŒÙ†Ú© Ú©Ø§Ø± Ù†Ú©Ø±Ø¯ØŒ <b>Ú©Ø¯ Ø®Ø§Ù…</b> Ø±Ø§ Ø¨ÙØ±Ø³ØªÛŒØ¯.</p>
            
            <button class="btn" onclick="copyData('link')" style="margin-bottom:8px">ğŸ“‹ Ú©Ù¾ÛŒ Ù„ÛŒÙ†Ú© (Ø¢Ø³Ø§Ù†)</button>
            <button class="btn sec" onclick="copyData('raw')" style="font-size:12px">ğŸ“„ Ú©Ù¾ÛŒ Ú©Ø¯ Ø®Ø§Ù… (ØªØ¶Ù…ÛŒÙ†ÛŒ)</button>
        </div>

        <div class="card" style="margin-top:15px">
            <span class="badge">Ù…Ø±Ø­Ù„Ù‡ Û² Ø§Ø² Û²</span>
            <h2>ØªØ§ÛŒÛŒØ¯ Ø§ØªØµØ§Ù„</h2>
            <p>Ú©Ø¯ÛŒ Ú©Ù‡ Ø¯ÙˆØ³ØªØªØ§Ù† Ø¨Ù‡ Ø´Ù…Ø§ Ø¨Ø±Ù…ÛŒâ€ŒÚ¯Ø±Ø¯Ø§Ù†Ø¯ Ø±Ø§ Ø§ÛŒÙ†Ø¬Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:</p>
            <textarea id="hostAnswerInput" placeholder="Ú©Ø¯ ØªØ§ÛŒÛŒØ¯ Ù…Ù‡Ù…Ø§Ù† Ø±Ø§ Ø§ÛŒÙ†Ø¬Ø§ Paste Ú©Ù†ÛŒØ¯..."></textarea>
            <button class="btn" onclick="HOST_Connect()" style="margin-top:10px; background:var(--ok)">Ø§ØªØµØ§Ù„ Ù†Ù‡Ø§ÛŒÛŒ âš¡</button>
        </div>
    </div>

    <!-- SECTION: GUEST JOIN -->
    <div id="step-guest" class="hidden">
        <div class="card">
            <h2 style="color:var(--ok)">Ù¾Ø§Ø³Ø® Ø¨Ù‡ ØªÙ…Ø§Ø³</h2>
            <div id="guest-loading">
                <p>Ø¯Ø± Ø­Ø§Ù„ Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø§Ø·Ù„Ø§Ø¹Ø§Øª ØªÙ…Ø§Ø³... Ù„Ø·ÙØ§Ù‹ Ú†Ù†Ø¯ Ø«Ø§Ù†ÛŒÙ‡ ØµØ¨Ø± Ú©Ù†ÛŒØ¯.</p>
                <div style="height:4px; width:100%; background:#374151; border-radius:2px; overflow:hidden">
                    <div style="height:100%; background:var(--primary); width:50%; animation: load 2s infinite"></div>
                </div>
            </div>

            <div id="guest-ready" class="hidden">
                <p>Ú©Ø¯ ØªØ§ÛŒÛŒØ¯ Ø¢Ù…Ø§Ø¯Ù‡ Ø´Ø¯! Ø§ÛŒÙ† Ú©Ø¯ Ø±Ø§ Ú©Ù¾ÛŒ Ú©Ù†ÛŒØ¯ Ùˆ Ø¨Ø±Ø§ÛŒ Ù…ÛŒØ²Ø¨Ø§Ù† Ø¨ÙØ±Ø³ØªÛŒØ¯.</p>
                <textarea id="guestOutput" readonly onclick="this.select()"></textarea>
                <button class="btn" onclick="copyGuestResult()" style="margin-top:10px">ğŸ“‹ Ú©Ù¾ÛŒ Ú©Ø¯ ØªØ§ÛŒÛŒØ¯</button>
            </div>
        </div>
    </div>
    
    <!-- SECTION: MANUAL INPUT -->
    <div id="step-manual" class="hidden">
        <div class="card">
            <h2>ÙˆØ±ÙˆØ¯ Ú©Ø¯ Ø¯Ø³ØªÛŒ</h2>
            <textarea id="manualInput" placeholder="Ú©Ø¯ Ø·ÙˆÙ„Ø§Ù†ÛŒ Ø¯Ø¹ÙˆØª Ø±Ø§ Ø§ÛŒÙ†Ø¬Ø§ Paste Ú©Ù†ÛŒØ¯..."></textarea>
            <button class="btn" onclick="GUEST_ProcessManual()" style="margin-top:10px">Ø¨Ø±Ø±Ø³ÛŒ Ú©Ø¯</button>
            <button class="btn sec" onclick="location.reload()" style="margin-top:10px">Ø¨Ø§Ø²Ú¯Ø´Øª</button>
        </div>
    </div>

</div>

<script>
    // --- CORE VARIABLES ---
    const config = { iceServers: [{ urls: "stun:stun.l.google.com:19302" }] };
    let pc, localStream;
    let generatedCode = ""; 

    // --- UI HELPERS ---
    const el = (id) => document.getElementById(id);
    const show = (id) => el(id).classList.remove('hidden');
    const hide = (id) => el(id).classList.add('hidden');
    const toast = (msg) => { const t = el('toast'); t.textContent = msg; t.style.display='block'; setTimeout(()=>t.style.display='none', 2000); };
    
    // --- ENCODER / DECODER (SAFE URL) ---
    // This removes characters that break URLs
    const SafeBase64 = {
        encode: (json) => {
            return btoa(JSON.stringify(json)).replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
        },
        decode: (str) => {
            // Fix generic copy-paste errors
            let clean = str.toString().trim().replace(/\s/g, ''); 
            // Restore Base64 standard
            clean = clean.replace(/-/g, '+').replace(/_/g, '/');
            while (clean.length % 4) clean += '=';
            return JSON.parse(atob(clean));
        }
    };

    // --- 1. MEDIA ---
    async function startMedia() {
        try {
            localStream = await navigator.mediaDevices.getUserMedia({ video: {facingMode:'user'}, audio: true });
            el('localVideo').srcObject = localStream;
            return true;
        } catch(e) {
            alert("Ø®Ø·Ø§: Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ø¯ÙˆØ±Ø¨ÛŒÙ† Ø¯Ø§Ø¯Ù‡ Ù†Ø´Ø¯.");
            return false;
        }
    }

    // --- 2. WEBRTC ENGINE ---
    function createPC() {
        const peer = new RTCPeerConnection(config);
        localStream.getTracks().forEach(t => peer.addTrack(t, localStream));
        peer.ontrack = e => {
            el('remoteVideo').srcObject = e.streams[0];
            el('mainPanel').classList.add('minimized'); // HIDE PANEL ON CONNECT
        };
        return peer;
    }

    async function waitForICE(peer) {
        return new Promise(resolve => {
            if(peer.iceGatheringState === 'complete') resolve();
            else {
                const timer = setTimeout(resolve, 3000); // 3s Max wait
                peer.onicecandidate = e => { if(!e.candidate) { clearTimeout(timer); resolve(); }};
            }
        });
    }

    // --- 3. HOST FLOW ---
    async function HOST_Start() {
        const btn = el('btnStart'); btn.disabled = true; btn.innerText = "â³ Ø¯Ø± Ø­Ø§Ù„ Ø³Ø§Ø®Øª...";
        
        if(!await startMedia()) { btn.disabled=false; return; }

        pc = createPC();
        pc.createDataChannel("o2"); // ICE trigger

        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);
        await waitForICE(pc);

        // Generate Data
        generatedCode = SafeBase64.encode(pc.localDescription);
        const link = location.origin + location.pathname + '?c=' + generatedCode;

        // Update UI
        hide('step-start');
        show('step-host-share');
        window.currentLink = link;
    }

    function copyData(type) {
        if(type === 'link') {
            navigator.clipboard.writeText(window.currentLink);
            toast("Ù„ÛŒÙ†Ú© Ú©Ù¾ÛŒ Ø´Ø¯ âœ…");
        } else {
            navigator.clipboard.writeText(generatedCode);
            toast("Ú©Ø¯ Ø®Ø§Ù… Ú©Ù¾ÛŒ Ø´Ø¯ (Ù…Ø®ØµÙˆØµ Ø§ØªØµØ§Ù„ Ø¯Ø³ØªÛŒ) âœ…");
        }
    }

    async function HOST_Connect() {
        const txt = el('hostAnswerInput').value;
        if(!txt) return alert("Ú©Ø¯ ØªØ§ÛŒÛŒØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯!");

        try {
            const answer = SafeBase64.decode(txt);
            await pc.setRemoteDescription(answer);
            toast("Ù…ØªØµÙ„ Ø´Ø¯! Ù…Ù†ØªØ¸Ø± ØªØµÙˆÛŒØ± Ø¨Ø§Ø´ÛŒØ¯...");
        } catch(e) {
            alert("Ú©Ø¯ Ø§Ø´ØªØ¨Ø§Ù‡ Ø§Ø³Øª. Ù„Ø·ÙØ§ Ú©Ù„ Ù…ØªÙ† Ú©Ø¯ Ø±Ø§ Ø¨Ø§ Ø¯Ù‚Øª Ú©Ù¾ÛŒ Ú©Ù†ÛŒØ¯.");
        }
    }

    // --- 4. GUEST FLOW ---
    async function GUEST_ProcessManual() {
        const txt = el('manualInput').value;
        if(!txt) return;
        
        hide('step-start');
        hide('step-manual');
        show('step-guest');
        
        await GUEST_Run(txt);
    }

    function GUEST_ShowManual() {
        hide('step-start');
        show('step-manual');
    }

    async function GUEST_Run(codeStr) {
        if(!await startMedia()) return;

        try {
            const offer = SafeBase64.decode(codeStr);
            pc = createPC();
            await pc.setRemoteDescription(offer);
            
            const answer = await pc.createAnswer();
            await pc.setLocalDescription(answer);
            await waitForICE(pc);

            const answerCode = SafeBase64.encode(pc.localDescription);
            el('guestOutput').value = answerCode;

            hide('guest-loading');
            show('guest-ready');
            
        } catch(e) {
            alert("Ú©Ø¯ ÙˆØ±ÙˆØ¯ÛŒ Ø®Ø±Ø§Ø¨ ÛŒØ§ Ù†Ø§Ù‚Øµ Ø§Ø³Øª. Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ø§Ø² Ù…ÛŒØ²Ø¨Ø§Ù† Ø¨Ú¯ÛŒØ±ÛŒØ¯.");
            location.href = location.pathname;
        }
    }

    function copyGuestResult() {
        const txt = el('guestOutput');
        txt.select();
        txt.setSelectionRange(0, 99999);
        navigator.clipboard.writeText(txt.value);
        toast("Ú©Ù¾ÛŒ Ø´Ø¯! Ø¨Ø±Ø§ÛŒ Ù…ÛŒØ²Ø¨Ø§Ù† Ø¨ÙØ±Ø³ØªÛŒØ¯.");
    }

    // --- INIT ---
    // Check for URL Param
    window.onload = () => {
        const urlParams = new URLSearchParams(location.search);
        const code = urlParams.get('c');
        
        if(code) {
            // URL mode detected
            hide('step-start');
            show('step-guest');
            // Add a small delay to ensure UI renders
            setTimeout(() => {
                // We ask user to click a button to start media (Browser policy)
                const confirm = window.confirm("Ø¢ÛŒØ§ Ù…Ø§ÛŒÙ„ Ø¨Ù‡ Ø¨Ø±Ù‚Ø±Ø§Ø±ÛŒ ØªÙ…Ø§Ø³ Ù‡Ø³ØªÛŒØ¯ØŸ");
                if(confirm) GUEST_Run(code);
                else location.href = location.pathname;
            }, 500);
        }
    };

    // --- TOGGLES ---
    function toggleMute(btn) {
        if(!localStream) return;
        const t = localStream.getAudioTracks()[0];
        t.enabled = !t.enabled;
        btn.style.opacity = t.enabled ? 1 : 0.5;
    }
    function toggleCam(btn) {
        if(!localStream) return;
        const t = localStream.getVideoTracks()[0];
        t.enabled = !t.enabled;
        btn.style.opacity = t.enabled ? 1 : 0.5;
    }

</script>
<style>
    @keyframes load { 0% { transform:translateX(-100%) } 100% { transform:translateX(200%) } }
</style>
</body>
</html>
